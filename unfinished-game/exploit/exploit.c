#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdlib.h>
#include <pthread.h>
#include <stdbool.h>

typedef uint64_t u8;
typedef struct ranctx { u8 a; u8 b; u8 c; u8 d; } ranctx;

#define rot(x,k) (((x)<<(k))|((x)>>(64-(k))))
u8 ranval( ranctx *x ) {
    u8 e = x->a - rot(x->b, 7);
    x->a = x->b ^ rot(x->c, 13);
    x->b = x->c + rot(x->d, 37);
    x->c = x->d + e;
    x->d = e + x->a;
    return x->d;
}

void raninit( ranctx *x, u8 seed ) {
    u8 i;
    x->a = 0xf1ea5eed, x->b = x->c = x->d = seed;
    for (i=0; i<20; ++i) {
        (void)ranval(x);
    }
}

void tfunc(uint32_t i){
        for(;;i++){
                u8 seed_part = i;
                seed_part = (seed_part<<32)>>32;
                u8 seed = ((seed_part<<32) | seed_part);
                ranctx x = {0};
                raninit(&x,seed);
                u8 tval = ranval(&x);
                uint8_t *tptr = (uint8_t*)&tval;
                uint8_t tmp[] = {0x99,0x01,0xc2,0x6b,0x62,0x08,0xba,0x3a,0xf5,0x4a,0x97,0xab,0xba,0x3d,0x36,0xf9,0};
                bool nf = false;
                for(int j=0;j<sizeof(tval);j++){
                       tmp[j] = tptr[j]^tmp[j];
                       if((tmp[j]<0x21) || (tmp[j])>0x7e) {nf=true;break;}
                }
                if(nf) continue;
                if(!memcmp(tmp,"flag{",4)){
                        printf("Broken: %llx %llx\n",seed_part,seed);
                        printf("%s\n",tmp);
                        exit(0);
                        break;
                }
                if(i==UINT32_MAX){
                        printf("No solution found\n");
                        break;
                }
        }
}

enum{ nthreads = 8};
int main(){
        uint32_t frac = UINT32_MAX/nthreads;
        printf("MAX: %u\n",UINT32_MAX);
        pthread_t tid[nthreads]={0};
        for(int k=0; k<nthreads; k++){
                uint32_t start = (k*frac);
                pthread_create(&tid[k],NULL,(void*)tfunc,(void*)start);
        }
        for(int i=0;i<nthreads;i++){
                pthread_join(tid[i], NULL);
        }
}
