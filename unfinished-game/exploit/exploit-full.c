#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdlib.h>
#include <pthread.h>
#include <stdbool.h>

typedef uint64_t u8;
typedef struct ranctx { u8 a; u8 b; u8 c; u8 d; } ranctx;

#define rot(x,k) (((x)<<(k))|((x)>>(64-(k))))
u8 ranval( ranctx *x ) {
    u8 e = x->a - rot(x->b, 7);
    x->a = x->b ^ rot(x->c, 13);
    x->b = x->c + rot(x->d, 37);
    x->c = x->d + e;
    x->d = e + x->a;
    return x->d;
}

void raninit( ranctx *x, u8 seed ) {
    u8 i;
    x->a = 0xf1ea5eed, x->b = x->c = x->d = seed;
    for (i=0; i<20; ++i) {
        (void)ranval(x);
    }
}

int main(){
         u8 seed = 0x6f474c9ae586f3fa;
         printf("seed: %llx\n",seed);
        uint8_t leaked_bytes[] = {0x89,0x6b,0x37,0x11,0x60,0x9a,0xb1,0x3d,0x62,0x36,0xd8,0x3,0x25,0x81,0x30,0x5b,0xc1,0xeb,0xa,0x79,0xaa,0x45,0xab,0xbe,0x85,0xf2,0x71,0xdf,0xc1,0x3,0x7c,0xed,0x30,0x6b,0x76,0x31,0x65,0x7d};
         u8 seed_part = seed;
         seed_part = (seed_part>>32);
         seed = ((seed_part<<32) | seed_part);
         
         printf("seed: %llx\n",seed);
         ranctx x = {0};
         raninit(&x,seed);

         u8 tval = 0;
         uint8_t *tptr = (uint8_t*)&tval;

         for(int i=0;i<32/8;i++){
                tval = ranval(&x);
                for(int j=0; j<8; j++){
                        int idx = (i*8)+j;
                        leaked_bytes[idx] = leaked_bytes[idx]^tptr[j];
                }
         }

         for(uint64_t i=0; i<UINT32_MAX;i++){
               seed_part = (i<<32)>>32;
               seed = (seed_part<<32)|seed_part;
               raninit(&x,seed);
               tval = ranval(&x);
               bool nf = false;
               uint8_t tmp[32] = {0};
               for(int j=0;j<sizeof(tval);j++){
                       tmp[j] = tptr[j]^leaked_bytes[j];
                       if((tmp[j]<0x21) || (tmp[j])>0x7e) {nf=true;break;}
               }
               if(nf) continue;
               if(!memcmp(tmp,"flag{",5)){
                        printf("Broken: %llx %llx\n",seed_part,seed);
                        raninit(&x,seed);
                        for(int k=0;k<32/8;k++){
                                tval = ranval(&x);
                                for(int l=0;l<8;l++){
                                        int idx = (k*8)+l;
                                        tmp[idx] = leaked_bytes[idx]^tptr[l];
                                }
                        }


                        printf("%s\n",tmp);
                        exit(0);
                        break;
               }
         }
}
